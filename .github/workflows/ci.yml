name: Despliegue AutomÃ¡tico

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar SSH
      run: |
        mkdir -p ~/.ssh

        # Guardar clave privada desde secret (sin comillas ni espacios)
        echo "${{ secrets.VM_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

        # ConfiguraciÃ³n SSH para conectar sin preguntas
        cat > ~/.ssh/config << EOF
Host azure-vm
  HostName ${{ secrets.VM_HOST }}
  User ${{ secrets.VM_USER }}
  IdentityFile ~/.ssh/deploy_key
  IdentitiesOnly yes
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null
EOF

    - name: Probar conexiÃ³n SSH
      run: |
        echo "ðŸ” Probando conexiÃ³n SSH..."
        ssh -o ConnectTimeout=10 azure-vm "echo 'âœ… Conectado a servidor: $(hostname)'" || exit 1

    - name: Sincronizar cÃ³digo al servidor
      run: |
        echo "ðŸ“ Copiando archivos al VPS con rsync..."
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude=.git \
          --exclude=__pycache__ \
          --exclude=*.pyc \
          --exclude=.env \
          ./ \
          ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/opt/billing_api/billing_api/

    - name: Ejecutar comandos remotos (migraciones, reinicios)
      run: |
        echo "ðŸš€ Ejecutando comandos en el servidor..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          cd /opt/billing_api/billing_api

          echo "ðŸ“¦ Activando entorno virtual..."
          source /opt/billing_api/venv/bin/activate

          echo "ðŸ“˜ Instalando dependencias..."
          pip install -r requirements.txt

          echo "ðŸ”„ Ejecutando migraciones..."
          python manage.py migrate --noinput

          echo "â™»ï¸ Reiniciando servicios..."
          sudo systemctl restart gunicorn
          sudo systemctl restart nginx

          echo "âœ… Despliegue completado exitosamente"
EOF

name: Despliegue AutomÃ¡tico

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Configurar SSH
      run: |
        mkdir -p ~/.ssh
        # Guardar clave privada COMPLETA
        echo "${{ secrets.VM_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Configurar sin confirmaciones
        cat > ~/.ssh/config << EOF
        Host azure-vm
          HostName ${{ secrets.VM_HOST }}
          User ${{ secrets.VM_USER }}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
    - name: Probar conexiÃ³n
      run: |
        echo "ðŸ” Probando conexiÃ³n SSH..."
        ssh -o ConnectTimeout=10 azure-vm "echo 'âœ… Conectado a $(hostname)'" || exit 1
        
    - name: Sincronizar cÃ³digo
      run: |
        echo "ðŸ“ Copiando archivos..."
        rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude=.git \
          --exclude=__pycache__ \
          --exclude=*.pyc \
          --exclude=.env \
          ./ \
          ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/opt/billing_api/billing_api/
          
    - name: Ejecutar en servidor
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          cd /opt/billing_api/billing_api
          source /opt/billing_api/venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate --noinput
          sudo systemctl restart gunicorn
          sudo systemctl restart nginx
          echo "âœ… Despliegue completado"
        EOF
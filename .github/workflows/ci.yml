name: Despliegue Autom√°tico a Azure

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: Configurar conexi√≥n SSH CORRECTAMENTE
        run: |
          # Crear directorio .ssh con permisos correctos
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Guardar la clave privada COMPLETA
          echo "${{ secrets.VM_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Configurar ssh para no pedir confirmaci√≥n
          echo "Host azure-vm" >> ~/.ssh/config
          echo "  HostName ${{ secrets.VM_HOST }}" >> ~/.ssh/config
          echo "  User ${{ secrets.VM_USER }}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/deploy_key" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          echo "  LogLevel ERROR" >> ~/.ssh/config
          
          # Probar conexi√≥n (esto fallar√° silenciosamente si hay error)
          ssh -o ConnectTimeout=5 azure-vm "echo 'Conexi√≥n SSH exitosa'" || true

      - name: Probar conexi√≥n SSH expl√≠citamente
        run: |
          echo "üîç Probando conexi√≥n SSH..."
          ssh -v -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "whoami && echo '‚úÖ SSH funciona'" || echo "‚ùå Fall√≥ SSH"

      - name: Actualizar archivo .env en la VM
        run: |
          echo "üîÑ Actualizando .env en la VM..."
          # Crear archivo temporal
          echo "${{ secrets.ENV_FILE }}" > /tmp/env_temp
          
          # Copiar usando scp con clave expl√≠cita
          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              /tmp/env_temp \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/opt/billing_api/.env
          
          # Verificar que se copi√≥
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "ls -la /opt/billing_api/.env && echo '‚úÖ .env copiado correctamente'"
          
          rm /tmp/env_temp

      - name: Sincronizar c√≥digo
        run: |
          echo "üìÅ Sincronizando archivos..."
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='db.sqlite3' \
            --exclude='.github' \
            ./ \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/opt/billing_api/billing_api/

      - name: Ejecutar comandos en la VM
        run: |
          echo "üöÄ Ejecutando comandos en la VM..."
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            
            echo "üìÇ Cambiando al directorio del proyecto..."
            cd /opt/billing_api/billing_api
            
            echo "üêç Activando entorno virtual..."
            source /opt/billing_api/venv/bin/activate
            
            echo "üì¶ Instalando dependencias..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            echo "üîÑ Aplicando migraciones..."
            python manage.py migrate --noinput
            
            echo "üìä Recolectando archivos est√°ticos..."
            python manage.py collectstatic --noinput --clear
            
            echo "üîÑ Reiniciando servicios..."
            sudo systemctl daemon-reload
            sudo systemctl restart gunicorn
            sudo systemctl restart nginx
            
            echo "‚úÖ Despliegue completado exitosamente!"
            
            echo "üîç Verificando servicios..."
            sudo systemctl status gunicorn --no-pager
            sudo systemctl status nginx --no-pager
            
          EOF

      - name: Verificar despliegue
        run: |
          echo "üåê Verificando que la API responde..."
          sleep 5
          curl -f http://${{ secrets.VM_HOST }}/ || \
          curl -f http://${{ secrets.VM_HOST }}/api/ || \
          echo "‚ö†Ô∏è  La API podr√≠a estar iniciando, verifica manualmente"